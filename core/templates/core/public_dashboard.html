{% extends 'core/base.html' %}

{% block title %}แดชบอร์ดสาธารณะ{% endblock %}

{% block content %}
<h1 class="text-white fw-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">แดชบอร์ดข้อมูลสาธารณะ</h1>

<form method="get" class="mb-4 p-3 bg-light rounded shadow-sm d-flex flex-wrap gap-3 align-items-center">
    <div class="d-flex align-items-center gap-2">
        <label class="fw-bold">ปี:</label>
        <select name="year" class="form-select" onchange="this.form.submit()" style="width: auto;">
            <option value="">ทั้งหมด</option>
            {# fmt: off #}
            {% for year in years %}
            <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
            {# fmt: on #}
        </select>
    </div>

    <div class="d-flex align-items-center gap-2">
        <label class="fw-bold">เดือน:</label>
        <select name="month" class="form-select" onchange="this.form.submit()" style="width: auto;">
            <option value="">ทั้งหมด</option>
            {# fmt: off #}
            {% for m_num, m_name in months %}
            <option value="{{ m_num }}" {% if selected_month == m_num %}selected{% endif %}> {{ m_name }}</option>
            {% endfor %}
            {# fmt: on #}
        </select>
    </div>

    <a href="{% url 'public_dashboard' %}" class="btn btn-outline-secondary ms-auto">ล้างตัวกรอง</a>
</form>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card p-4">
            <h3 class="card-title text-center">จำนวนเรื่องร้องเรียนตามสถานะ</h3>
            <canvas id="statusChart"></canvas>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card p-4">
            <h3 class="card-title text-center">ประเภทปัญหา</h3>
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

{{ status_labels|json_script:"status-labels" }}
{{ status_counts|json_script:"status-counts" }}

{{ category_labels|json_script:"category-labels" }}
{{ category_counts|json_script:"category-counts" }}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ดึงข้อมูลสำหรับกราฟแท่ง
        var statusLabels = JSON.parse(document.getElementById('status-labels').textContent);
        var statusCounts = JSON.parse(document.getElementById('status-counts').textContent);

        // ดึงข้อมูลสำหรับกราฟวงกลม
        var categoryLabels = JSON.parse(document.getElementById('category-labels').textContent);
        var categoryCounts = JSON.parse(document.getElementById('category-counts').textContent);

        // สร้างกราฟแท่ง
        var ctxStatus = document.getElementById('statusChart').getContext('2d');
        var statusChart = new Chart(ctxStatus, {
            type: 'bar',
            data: {
                labels: statusLabels,
                datasets: [{
                    label: 'จำนวนเรื่อง',
                    data: statusCounts,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(255, 159, 64, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(75, 192, 192, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // สร้างกราฟวงกลม - NEW
        var ctxCategory = document.getElementById('categoryChart').getContext('2d');
        var categoryChart = new Chart(ctxCategory, {
            type: 'doughnut', // ใช้ 'doughnut' หรือ 'pie' ก็ได้
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'จำนวนเรื่อง',
                    data: categoryCounts,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                    ],
                    hoverOffset: 4
                }]
            }
        });
    });
</script>
{% endblock %}